!function(){var a=Handlebars.template,n=Handlebars.templates=Handlebars.templates||{};n["live-editor"]=a(function(a,n,s,t,l){function r(){return"Loading..."}function e(){return"Restart"}function o(a){var n="";return n+='\n                <a href="" class="draw-color-button" id="'+g(typeof a===u?a.apply(a):a)+'">\n                    <span></span>\n                </a>\n                '}function i(){return"Record"}function c(){return"Enable Flash to load audio:"}function d(){return"Play"}function p(){return"Loading audio..."}this.compilerInfo=[4,">= 1.0.0"],s=this.merge(s,a.helpers),l=l||{};var h,v,y,f="",u="function",g=this.escapeExpression,b=this,m=s.blockHelperMissing;return f+='<div class="scratchpad-wrap">\n    <!-- Canvases (Drawing + Output) -->\n    <div class="scratchpad-canvas-wrap">\n        <div id="output">\n            <!-- Extra data-src attribute to work around\n                 cross-origin access policies. -->\n            <iframe id="output-frame"\n                src="',(v=s.execFile)?h=v.call(n,{hash:{},data:l}):(v=n&&n.execFile,h=typeof v===u?v.call(n,{hash:{},data:l}):v),f+=g(h)+'"\n                data-src="',(v=s.execFile)?h=v.call(n,{hash:{},data:l}):(v=n&&n.execFile,h=typeof v===u?v.call(n,{hash:{},data:l}):v),f+=g(h)+'"></iframe>\n            <canvas class="scratchpad-draw-canvas" style="display:none;"\n                width="400" height="400"></canvas>\n\n            <div class="overlay disable-overlay" style="display:none;">\n            </div>\n\n            <div class="scratchpad-canvas-loading">\n                <img src="',(v=s.imagesDir)?h=v.call(n,{hash:{},data:l}):(v=n&&n.imagesDir,h=typeof v===u?v.call(n,{hash:{},data:l}):v),f+=g(h)+'/throbber-full.gif">\n                <span class="hide-text">',y={hash:{},inverse:b.noop,fn:b.program(1,r,l),data:l},(v=s._)?h=v.call(n,y):(v=n&&n._,h=typeof v===u?v.call(n,y):v),s._||(h=m.call(n,h,{hash:{},inverse:b.noop,fn:b.program(1,r,l),data:l})),(h||0===h)&&(f+=h),f+='</span>\n            </div>\n        </div>\n\n        <div class="scratchpad-toolbar">\n            <button id="restart-code"\n                class="simple-button pull-right">\n                <span class="glyphicon glyphicon-refresh icon-refresh"></span>\n                ',y={hash:{},inverse:b.noop,fn:b.program(3,e,l),data:l},(v=s._)?h=v.call(n,y):(v=n&&n._,h=typeof v===u?v.call(n,y):v),s._||(h=m.call(n,h,{hash:{},inverse:b.noop,fn:b.program(3,e,l),data:l})),(h||0===h)&&(f+=h),f+='</button>\n\n            <!-- Widgets for selecting colors to doodle on the canvas during\n                recordings -->\n            <div id="draw-widgets" style="display:none;">\n                <a href="" id="draw-clear-button" class="ui-button">\n                    <span class="ui-icon-cancel"></span>\n                </a>\n                ',h=s.each.call(n,n&&n.colors,{hash:{},inverse:b.noop,fn:b.program(5,o,l),data:l}),(h||0===h)&&(f+=h),f+='\n            </div>\n\n            <!-- Record button -->\n            <button id="record" class="simple-button pull-left" style="display:none;">',y={hash:{},inverse:b.noop,fn:b.program(7,i,l),data:l},(v=s._)?h=v.call(n,y):(v=n&&n._,h=typeof v===u?v.call(n,y):v),s._||(h=m.call(n,h,{hash:{},inverse:b.noop,fn:b.program(7,i,l),data:l})),(h||0===h)&&(f+=h),f+='</button>\n        </div>\n    </div>\n\n    <!-- Editor -->\n    <div class="scratchpad-editor-wrap overlay-container">\n        <div class="scratchpad-editor-tabs">\n          <div id="scratchpad-code-editor-tab" class="scratchpad-editor-tab">\n            <div class="scratchpad-editor scratchpad-ace-editor"></div>\n            <div class="overlay disable-overlay" style="display:none;">\n            </div>\n\n            <div class="scratchpad-editor-bigplay-loading" style="display:none;">\n                <img src="',(v=s.imagesDir)?h=v.call(n,{hash:{},data:l}):(v=n&&n.imagesDir,h=typeof v===u?v.call(n,{hash:{},data:l}):v),f+=g(h)+'/throbber-full.gif">\n                <span class="hide-text">',y={hash:{},inverse:b.noop,fn:b.program(1,r,l),data:l},(v=s._)?h=v.call(n,y):(v=n&&n._,h=typeof v===u?v.call(n,y):v),s._||(h=m.call(n,h,{hash:{},inverse:b.noop,fn:b.program(1,r,l),data:l})),(h||0===h)&&(f+=h),f+='</span>\n            </div>\n\n            <!-- This cannot be removed, if we want Flash to keep working! -->\n            <div id="sm2-container">\n                ',y={hash:{},inverse:b.noop,fn:b.program(9,c,l),data:l},(v=s._)?h=v.call(n,y):(v=n&&n._,h=typeof v===u?v.call(n,y):v),s._||(h=m.call(n,h,{hash:{},inverse:b.noop,fn:b.program(9,c,l),data:l})),(h||0===h)&&(f+=h),f+='\n                <br>\n            </div>\n\n            <button class="scratchpad-editor-bigplay-button" style="display:none;">\n                <span class="glyphicon glyphicon-play icon-play"></span>\n                <span class="hide-text">',y={hash:{},inverse:b.noop,fn:b.program(11,d,l),data:l},(v=s._)?h=v.call(n,y):(v=n&&n._,h=typeof v===u?v.call(n,y):v),s._||(h=m.call(n,h,{hash:{},inverse:b.noop,fn:b.program(11,d,l),data:l})),(h||0===h)&&(f+=h),f+='</span>\n            </button>\n          </div>\n        </div>\n\n        <div class="scratchpad-toolbar">\n            <!-- Row for playback controls -->\n            <div class="scratchpad-playbar" style="display:none;">\n                <div class="scratchpad-playbar-area" style="display:none;">\n                    <button\n                        class="simple-button primary scratchpad-playbar-play"\n                        type="button">\n                        <span class="glyphicon glyphicon-play icon-play"></span>\n                    </button>\n\n                    <div class="scratchpad-playbar-progress"></div>\n\n                    <span class="scratchpad-playbar-timeleft"></span>\n                </div>\n                <div class="loading-msg">\n                    ',y={hash:{},inverse:b.noop,fn:b.program(13,p,l),data:l},(v=s._)?h=v.call(n,y):(v=n&&n._,h=typeof v===u?v.call(n,y):v),s._||(h=m.call(n,h,{hash:{},inverse:b.noop,fn:b.program(13,p,l),data:l})),(h||0===h)&&(f+=h),f+='\n                </div>\n            </div>\n        </div>\n\n        <div class="scratchpad-toolbar scratchpad-dev-record-row" style="display:none;"></div>\n    </div>\n</div>'})}();
window.ScratchpadDrawCanvas=Backbone.View.extend({initialize:function(t){this.record=t.record,this.undoStack=[],this.isDrawing=!1,this.ctx=this.el.getContext("2d"),this.ctx.shadowBlur=2,this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.lineWidth=1,this.clear(!0),this.record&&this.bindRecordView()},commands:["startLine","drawLine","endLine","setColor","clear"],mouseCommands:["move","over","out","down","up"],colors:{black:[0,0,0],red:[255,0,0],orange:[255,165,0],green:[0,128,0],blue:[0,0,255],lightblue:[173,216,230],violet:[128,0,128]},remove:function(){this.clear(!0),this.endDraw(),this.$el.off(".draw-canvas"),$(document).off(".draw-canvas")},bindRecordView:function(){var t=this,n=this.record;this.$el.on({"mousedown.draw-canvas":function(i){n.recording&&0===i.button&&(t.startLine(i.offsetX,i.offsetY),i.preventDefault())},"mousemove.draw-canvas":function(i){n.recording&&t.drawLine(i.offsetX,i.offsetY)},"mouseup.draw-canvas":function(){n.recording&&t.endLine()},"mouseout.draw-canvas":function(){n.recording&&t.endLine()}}),n.on({runSeek:function(){t.clear(!0),t.endDraw()}}),n.seekCachers.canvas={getState:function(){if(t.isDrawing){var n=document.createElement("canvas");return n.width=n.height=t.el.width,n.getContext("2d").drawImage(t.el,0,0),{x:t.x,y:t.y,down:t.down,color:t.color,canvas:n}}},restoreState:function(n){t.startDraw(),t.x=n.x,t.y=n.y,t.down=n.down,t.setColor(n.color),t.ctx.drawImage(n.canvas,0,0)}},_.each(this.commands,function(i){n.handlers[i]=function(n){t[i].apply(t,n[i]||[])}}),_.each(this.mouseCommands,function(i){n.handlers[i]=function(n){t.trigger("mouseEvent",{name:i,action:n})}}),$(document).on("keydown.draw-canvas",function(i){n.playing&&t.isDrawing&&8===i.which&&(i.preventDefault(),t.undo())})},undo:function(){this.record.log({canvas:"undo"});var t=this.undoStack.pop();if(t&&"endLine"===t.name)for(;"startLine"!==t.name;)t=this.undoStack.pop();this.redraw()},redraw:function(){var t=this.undoStack.slice(0);this.clear(!0),this.undoStack.length=0,this.undoRunning=!0;for(var n=0,i=t.length;i>n;n++)this[t[n].name].apply(this,t[n].args);this.undoRunning=!1},startLine:function(t,n){this.down||(this.down=!0,this.x=t,this.y=n,this.log("startLine",[t,n]))},drawLine:function(t,n){this.down&&null!=this.x&&null!=this.y&&(this.ctx.beginPath(),this.ctx.moveTo(this.x,this.y),this.ctx.lineTo(t,n),this.ctx.stroke(),this.ctx.closePath(),this.x=t,this.y=n,this.log("drawLine",[t,n]))},endLine:function(){this.down&&(this.down=!1,this.log("endLine"))},log:function(t,n){if(n=n||[],!this.undoRunning){var i={};i[t]=n,this.record.log(i)}this.undoStack.push({name:t,args:n})},setColor:function(t){null!=t&&(this.isDrawing||this.startDraw(!0),this.color=t,this.ctx.shadowColor="rgba("+this.colors[t]+",0.5)",this.ctx.strokeStyle="rgba("+this.colors[t]+",1.0)",this.log("setColor",[t])),this.trigger("colorSet",t)},clear:function(t){this.ctx.clearRect(0,0,600,480),this.x=null,this.y=null,this.down=!1,t!==!0&&this.log("clear")},startDraw:function(t){this.isDrawing||(this.isDrawing=!0,this.undoStack.length=0,t!==!0&&this.setColor("black"),this.trigger("drawStarted"))},endDraw:function(){this.isDrawing&&(this.isDrawing=!1,this.setColor(null),this.trigger("drawEnded"))}});
window.ScratchpadEditor=Backbone.View.extend({initialize:function(e){var t=this;this.defaultCode=e.code,this.autoFocus=e.autoFocus,this.config=e.config,this.record=e.record,this.editor=ace.edit(this.el),this.textarea=this.$(this.dom.TEXT_INPUT),this.content=this.$(this.dom.CONTENT),this.offset=this.content.offset();new HotNumber({imagesDir:e.imagesDir,type:"ace",editor:this.editor,record:this.record});this.$el.resizable&&this.$el.resizable({handles:"s",resize:function(){t.editor.resize()}}),this.$el.on("mousedown",".hotnumber",function(e){e.preventDefault()}),this.editor.commands.removeCommand("gotoline"),this.editor.selection.addEventListener("changeCursor",function(){t.setErrorHighlight(!1)}),this.editor.on("change",function(){t.trigger("change")}),$(this.config).on("versionSwitched",function(e){t.config.runVersion(e,"editor",t.editor)}),this.config.editor=this,this.reset(),this.record&&this.bindRecord()},dom:{ACTIVE_LINE:".ace_active_line",TEXT_INPUT:"textarea",CONTENT:"div.ace_content"},bindRecord:function(){var e=this,t=this.editor,o=this.record;t.setKeyboardHandler({handleKeyboard:function(n,i,r,c,s){if(o.playing||e.trigger("userChangedCode"),-1===i&&e.trigger("keyInput"),o.recording){var l=t.commands.findKeyCommand(i,r),a=jQuery.isEmptyObject(s);if(l&&!a){o.log({cmd:l.name}),e.blockSelection();var u=l.exec;return l.exec=function(){o.recording=!1;var e=u.apply(this,arguments);return o.recording=!0,e},l}!l&&a&&(o.log({key:r}),e.blockSelection())}}}),t.addEventListener("copy",function(){o.log({copy:1})}),t.addEventListener("paste",function(t){e.trigger("userChangedCode"),o.recording&&o.log({paste:t})}),t.addEventListener("cut",function(){e.trigger("userChangedCode"),o.log({cut:1}),e.blockSelection()}),t.renderer.scrollBar.addEventListener("scroll",function(e){o.log({top:e.data})}),t.selection.addEventListener("changeCursor",function(){t.selection.isEmpty()&&e.handleSelect()}),t.selection.addEventListener("changeSelection",this.handleSelect.bind(this)),$.extend(o.handlers,{cut:function(){t.onCut()},copy:function(){t.getCopyText()},paste:function(e){t.onPaste(e.paste)},cmd:function(o){t.commands.exec(o.cmd,e.editor)},key:function(e){t.onTextInput(e.key,!1)},top:function(e){t.renderer.scrollBar.setScrollTop(e.top)},start:function(e){e.end||(e.end=e.start),t.selection.setSelectionRange(e)},focus:function(){e.textarea[0].focus()}}),o.seekCachers.editor={getState:function(){return{text:e.text(),cursor:e.getCursor()}},restoreState:function(t){e.text(t.text),e.setCursor(t.cursor)}},o.on({runSeek:function(){e.reset(o.initData.code)}})},doSelect:!0,curRange:null,blockSelection:function(){var e=this;this.doSelect=!1,setTimeout(function(){e.doSelect=!0},13)},handleSelect:function(){if(this.doSelect&&this.record.recording){var e=this;this.curRange||(setTimeout(function(){var t=e.curRange,o={start:{row:t.start.row,column:t.start.column}};(t.end.row!==t.start.row||t.end.column!==t.start.column)&&(o.end={row:t.end.row,column:t.end.column});var n=e.record.commands[e.record.commands.length-1];n&&(n=JSON.stringify({start:n.start,end:n.end})),n&&n===JSON.stringify(o)||e.record.log(o),e.curRange=null},13),this.curRange=this.editor.selection.getRange())}},reset:function(e,t){e=e||this.defaultCode,this.config.runCurVersion("editor",this.editor),this.text(e),this.setCursor({row:0,column:0},t)},setErrorHighlight:function(e){var t=this;this.editor.setHighlightActiveLine(e),setTimeout(function(){var e=t.$(t.dom.ACTIVE_LINE).addClass("hilite");setTimeout(function(){e.removeClass("hilite")},100)},1)},toggleGutter:function(e){this.editor.renderer.setShowGutter(e)},focus:function(){this.autoFocus!==!1&&this.editor.focus()},getCursor:function(){return this.editor.getCursorPosition()},setCursor:function(e,t){this.editor.moveCursorToPosition(e),this.editor.clearSelection(),t!==!1&&this.autoFocus!==!1&&this.editor.focus()},setSelection:function(e){this.editor.selection.setSelectionRange(e)},setReadOnly:function(e){this.editor.setReadOnly(e)},text:function(e){return null==e?this.editor.getSession().getValue().replace(/\r/g,"\n"):(this.editor.getSession().setValue(e),this)},unfold:function(){return this.editor.getSession().unfold()},insertNewlineIfCursorAtEnd:function(){var e=this.editor.getSession().getLength()-1,t=this.editor.getSession().getLine(e),o=t.length,n=this.editor.getCursorPosition();if(n.row===e&&n.column===o){var i=this.text();i.length&&"\n"!==i[i.length-1]&&(this.text(this.text()+"\n"),this.setCursor({row:e+1,column:0}))}},setReadOnly:function(e){this.editor.setReadOnly(e)},undo:function(){this.editor.undo()}}),window.ScratchpadBlocklyEditor=Backbone.View.extend({initialize:function(e){this.defaultCode=e.code,this.autoFocus=e.autoFocus,this.config=e.config,this.record=e.record,this.config.editor=this;var t="<xml>",o=function(e){var t="";return e.args&&e.args.forEach(function(e){"fill"in e&&(t+="<value name='"+e.name+"'>","Colour"===e.type?t+="<block type='colour_picker'></block>":"Image"===e.type?t+="<block type='image_picker'></block>":"String"===e.type?t+="<block type='text'><field name='TEXT'>"+e.fill+"</field></block>":"Number"===e.type?t+="<block type='math_number'><field name='NUM'>"+e.fill+"</field></block>":"Variable"===e.type&&(t+="<block type='variables_get'><field name='VAR'>"+e.fill+"</field></block>"),t+="</value>")}),t};Object.keys(Blockly.p5js).forEach(function(e){t+="<category name='"+e+"'>";var n=Blockly.js[e];n&&Object.keys(n).forEach(function(e){t+="<block type='"+e+"'>",t+=o(n[e]),t+="</block>"});var i=Blockly.p5js[e];Object.keys(i).forEach(function(e){t+="<block type='p5js_"+e+"'>",t+=o(i[e]),t+="</block>"}),t+="</category>"}),Object.keys(Blockly.js).forEach(function(e){if(!(e in Blockly.p5js)){var n=Blockly.js[e];t+="<category name='"+e+"'>",Object.keys(n).forEach(function(e){t+="<block type='"+e+"'>",t+=o(n[e]),t+="</block>"}),t+="</category>"}}),t+="<category name='Functions' custom='PROCEDURE'></category>",t+="</xml>",Blockly.inject(this.el,{path:e.externalsDir+"blockly/",toolbox:t}),Blockly.addChangeListener(function(){this.trigger("change")}.bind(this));new HotNumber({blockly:Blockly,type:"blockly",imagesDir:e.imagesDir});this.$el.on("mousedown",".hotnumber",function(e){e.preventDefault()})},getCursor:function(){},setCursor:function(){},setSelection:function(){},focus:function(){},toggleGutter:function(){},setErrorHighlight:function(){},setReadOnly:function(){},undo:function(){},insertNewlineIfCursorAtEnd:function(){},setBlocklyFromJS:function(e){var t=Blockly.util.jsToBlocklyXml(e),o=Blockly.core.Xml.textToDom(t);o&&(Blockly.core.mainWorkspace.clear(),Blockly.core.Xml.domToWorkspace(Blockly.core.mainWorkspace,o))},text:function(e){return null!=e&&this.setBlocklyFromJS(e),Blockly.JavaScript.workspaceToCode()}});
window.ScratchpadAudioChunks=Backbone.Model.extend({initialize:function(){this.audioChunks=[],this.currentChunk=null},setCurrentChunk:function(t){this.currentChunk=t},currentChunkExists:function(){return!_.isNull(this.currentChunk)},startNewChunk:function(){this.currentChunk=null},discardCurrentChunk:function(){this.currentChunk=null},saveCurrentChunk:function(){this.currentChunk&&(this.audioChunks.push(this.currentChunk),this.currentChunk=null)},getAllChunks:function(){return this.audioChunks}}),window.ScratchpadRecordView=Backbone.View.extend({initialize:function(t){this.render(),this.$recordButton=t.recordButton,this.$finalSaveButton=t.saveButton,this.editor=t.editor,this.record=t.record,this.config=t.config,this.externalsDir=t.externalsDir,this.transloaditTemplate=t.transloaditTemplate,this.transloaditAuthKey=t.transloaditAuthKey,this.audioChunks=new ScratchpadAudioChunks,this.recordInProgress=!1,this.commandChunks=[],this.startingCode="",this.lastSavedCode=this.editor.text(),this.$lastAudioChunkElem=this.$el.find(".last-audio-chunk"),this.$savedAudioChunksElem=this.$el.find(".saved-audio-chunks"),this.initializeButtons()},render:function(){this.$el.html(Handlebars.templates["dev-record"]({})).show()},initializeButtons:function(){this.$newChunkButton=this.$el.find(".scratchpad-dev-new-chunk"),this.$discardChunkButton=this.$el.find(".scratchpad-dev-discard-chunk"),this.$saveChunkButton=this.$el.find(".scratchpad-dev-save-chunk"),this.$refreshEditorButton=this.$el.find(".scratchpad-dev-refresh-editor-state"),this.disableChunkButtons(!0,!0,!0,!0,!1),this.$newChunkButton.on("click",_.bind(this.newChunk,this)),this.$discardChunkButton.on("click",_.bind(this.discardChunk,this)),this.$saveChunkButton.on("click",_.bind(this.saveChunk,this)),this.$refreshEditorButton.on("click",_.bind(this.refreshEditor,this))},initializeRecordingAudio:function(){this.multirecorder=new MultiRecorder({workerPath:this.externalsDir+"multirecorderjs/multirecorder-worker.js"}),this.$recordButton.text("Use the chunks (and give permission)"),this.setButtonDisableStatus(this.$recordButton,!0),this.disableChunkButtons(!1,!0,!0,!0,!0)},startRecordingAudio:function(){var t=this;this.lastSavedCode=this.editor.text(),this.multirecorder.startRecording(1).progress(_.bind(function(t){this.$newChunkButton.text(t+"...")},this)).done(_.bind(function(){this.disableChunkButtons(!1,!0,!0,!0,!0),t.record.recordingAudio=!0,this.$newChunkButton.html("Stop recording chunk"),this.startRecordingCommands()},this))},stopRecordingAudio:function(){this.multirecorder.stopRecording().done(_.bind(function(t){this.audioChunks.setCurrentChunk(t),this.$lastAudioChunkElem.html(t.createAudioPlayer())},this))},showSavedAudioChunks:function(){this.getFinalAudioRecording(_.bind(function(t){this.$savedAudioChunksElem.html(t.createAudioPlayer())},this))},getDurationMsOfSavedAudio:function(){var t=0,i=$(this.$savedAudioChunksElem).find("audio");return i&&i.length>0&&(t=1e3*i[0].duration),t},startRecordingCommands:function(){if(this.record.hasNoChunks()){this.startingCode=this.editor.text();var t=this.config.curVersion();this.config.switchVersion(t),this.record.setActualInitData({configVersion:t,code:this.startingCode})}this.editor.focus(),this.record.startRecordChunk(this.getDurationMsOfSavedAudio()),this.record.log({start:{column:0,row:0}}),this.editor.setCursor({row:0,column:0})},stopRecordingCommands:function(){this.record.stopRecordChunk()},getFinalAudioRecording:function(t){this.multirecorder.combineRecordings(this.audioChunks.getAllChunks()).done(t)},getFinalCommandRecording:function(){return this.record.dumpRecording()},newChunk:function(){this.audioChunks.currentChunkExists()||(this.recordInProgress?(this.recordInProgress=!1,this.stopRecordingCommands(),this.disableChunkButtons(!0,!1,!1,!0,!0),this.$newChunkButton.html("Start new chunk")):(this.editor.editor.setReadOnly(!1),this.recordInProgress=!0,this.startRecordingAudio()))},discardChunk:function(){this.audioChunks.currentChunkExists()&&(this.audioChunks.discardCurrentChunk(),this.record.discardRecordChunk(),this.$lastAudioChunkElem.empty(),this.refreshEditor())},saveChunk:function(){this.audioChunks.currentChunkExists()&&(this.audioChunks.saveCurrentChunk(),this.record.saveRecordChunk(),this.lastSavedCode=this.editor.text(),this.disableChunkButtons(!1,!0,!0,!1,!1),this.showSavedAudioChunks(),this.$lastAudioChunkElem.empty())},refreshEditor:function(){this.record.loadRecording(this.record.dumpRecording()),this.editor.editor.setReadOnly(!1),this.record.initData=this.record.actualInitData,this.record.commands&&this.record.commands.push({time:this.getDurationMsOfSavedAudio()}),this.record.time=0,this.editor.text(this.startingCode),this.drawCanvas.clear(!0),this.drawCanvas.endDraw(),this.record.runSeek(this.getDurationMsOfSavedAudio()),setTimeout(_.bind(function(){this.disableChunkButtons(!1,!0,!0,!1,!1)},this),1e3)},disableChunkButtons:function(t,i,n,s,e){this.setButtonDisableStatus(this.$newChunkButton,t),this.setButtonDisableStatus(this.$discardChunkButton,i),this.setButtonDisableStatus(this.$saveChunkButton,n),this.setButtonDisableStatus(this.$refreshEditorButton,s),this.setButtonDisableStatus(this.$finalSaveButton,e)},setButtonDisableStatus:function(t,i){_.isUndefined(i)||t.prop("disabled",i)}});
window.LiveEditor=Backbone.View.extend({dom:{DRAW_CANVAS:".scratchpad-draw-canvas",DRAW_COLOR_BUTTONS:"#draw-widgets a.draw-color-button",EDITOR:".scratchpad-editor",CANVAS_LOADING:".scratchpad-canvas-loading",BIG_PLAY_LOADING:".scratchpad-editor-bigplay-loading",BIG_PLAY_BUTTON:".scratchpad-editor-bigplay-button",PLAYBAR:".scratchpad-playbar",PLAYBAR_AREA:".scratchpad-playbar-area",PLAYBAR_OPTIONS:".scratchpad-playbar-options",PLAYBAR_LOADING:".scratchpad-playbar .loading-msg",PLAYBAR_PROGRESS:".scratchpad-playbar-progress",PLAYBAR_PLAY:".scratchpad-playbar-play",PLAYBAR_TIMELEFT:".scratchpad-playbar-timeleft",PLAYBAR_UI:".scratchpad-playbar-play, .scratchpad-playbar-progress"},defaultOutputWidth:400,defaultOutputHeight:400,defaultEditorType:"p5js",editor:{p5js:ScratchpadEditor,blocklyp5js:ScratchpadBlocklyEditor},initialize:function(i){this.execDir=this._qualifyURL(i.execDir),this.externalsDir=this._qualifyURL(i.externalsDir),this.imagesDir=this._qualifyURL(i.imagesDir),this.execFile=this._qualifyURL(i.execFile),this.editorType=i.editorType||this.defaultEditorType,this.editorHeight=i.editorHeight,this.initialCode=i.code,this.initialVersion=i.version,this.settings=i.settings,this.validation=i.validation,this.recordingCommands=i.recordingCommands,this.recordingMP3=i.recordingMP3,this.transloaditTemplate=i.transloaditTemplate,this.transloaditAuthKey=i.transloaditAuthKey,this.render(),this.config=new ScratchpadConfig({version:i.version}),this.record=new ScratchpadRecord,this.drawCanvas=new ScratchpadDrawCanvas({el:this.dom.DRAW_CANVAS,record:this.record}),this.drawCanvas.on({mouseEvent:function(i){self.postFrame(i)}.bind(this),drawStarted:function(){this.$el.find(this.dom.DRAW_CANVAS).show()}.bind(this),drawEnded:function(){this.$el.find(this.dom.DRAW_CANVAS).hide()}.bind(this),colorSet:function(i){this.$el.find(this.dom.DRAW_COLOR_BUTTONS).removeClass("ui-state-active"),null!==i&&this.$el.find("#"+i).addClass("ui-state-active")}.bind(this)}),this.editor=new this.editor[this.editorType]({el:this.dom.EDITOR,autoFocus:i.autoFocus,config:this.config,record:this.record,imagesDir:this.imagesDir,externalsDir:this.externalsDir});var e=i.code;void 0!==e&&(this.editor.text(e),this.editor.originalCode=e),this.editor.focus(),i.cursor?this.editor.setCursor(i.cursor):this.editor.setSelection({start:{row:0,column:0},end:{row:0,column:0}}),this.$el.find("#page-overlay").hide(),this.updateCanvasSize(i.width,i.height),this.canRecord()&&this.$el.find("#record").show(),this.bind(),this.setupAudio()},render:function(){this.$el.html(Handlebars.templates["live-editor"]({execFile:this.execFile,imagesDir:this.imagesDir,colors:["black","red","orange","green","blue","lightblue","violet"]}))},bind:function(){var i=this,e=this.$el,t=this.dom;e.delegate(".simple-button.disabled, .ui-state-disabled","click",function(i){return i.stopImmediatePropagation(),!1}),e.delegate("#restart-code","click",this.restartCode.bind(this)),$(window).on("message",this.listenMessages.bind(this));var r=!1;e.find("#output-frame").on("load",function(){r=!0}),this.editor.on("change",function(){r=!0}),setInterval(function(){null!==r&&(this.runCode(r===!0?this.editor.text():r),r=null)}.bind(this),100),this.config.on("versionSwitched",function(i,e){r=!0,this.config.runVersion(e,"jshint")}.bind(this)),this.hasAudio()&&(e.find(t.DRAW_CANVAS).show(),e.find(".overlay").show(),e.find(t.BIG_PLAY_LOADING).show(),e.find(t.PLAYBAR).show()),e.find(t.DRAW_COLOR_BUTTONS).each(function(){$(this).addClass("ui-button").children().css("background",this.id)}),e.buttonize(),e.on("buttonClick","a.draw-color-button",function(){i.drawCanvas.setColor(this.id),i.editor.focus()}),e.on("click",".disable-overlay",function(){i.record.pausePlayback()}),e.find(t.PLAYBAR_PROGRESS).slider({range:"min",value:0,min:0,max:100,start:function(){return i.record.recording?!1:(i.record.seeking=!0,i.wasPlaying=i.record.playing,void i.record.pausePlayback())},slide:function(e,t){var r=1e3*t.value;r!==i.record.endTime()&&(i.updateTimeLeft(r),i.seekTo(r))},stop:function(e,t){i.record.seeking=!1,i.updateTimeLeft(1e3*t.value),i.wasPlaying&&setTimeout(function(){i.record.play()},1e3)}});var a=function(){i.record.playing?i.record.pausePlayback():i.record.play()};e.find(t.PLAYBAR_PLAY).off("click.play-button").on("click.play-button",a);var n=function(){e.find(t.PLAYBAR_LOADING).hide(),e.find(t.PLAYBAR_AREA).show(),e.find(t.BIG_PLAY_BUTTON).off("click.big-play-button").on("click.big-play-button",function(){e.find(t.BIG_PLAY_BUTTON).hide(),a()}),e.find(t.PLAYBAR_PLAY).on("click",function(){e.find(t.BIG_PLAY_BUTTON).hide()}),e.find(t.EDITOR).on("click",function(){e.find(t.BIG_PLAY_BUTTON).hide()}),e.find(t.BIG_PLAY_LOADING).hide(),e.find(t.BIG_PLAY_BUTTON).show(),i.off("readyToPlay",n)};this.on("readyToPlay",n),e.on("buttonClick","#draw-clear-button",function(){i.drawCanvas.clear(),i.drawCanvas.endDraw(),i.editor.focus()}),e.on("click","#restart-code",function(){i.record.log({restart:!0})}),e.find("#record").on("click",function(){i.recordHandler(function(i){i&&console.error(i)})}),this.recordingCommands&&this.record.loadRecording({init:{code:this.initialCode},commands:this.recordingCommands})},canRecord:function(){return this.transloaditAuthKey&&this.transloaditTemplate},hasAudio:function(){return!!this.recordingMP3},setupAudio:function(){if(this.hasAudio()){var i,e=this;soundManager.setup({url:this.externalsDir+"/soundmanager/",debugMode:!1,useFlashBlock:!0,onready:function(){window.clearTimeout(i),e.audioInit()},ontimeout:function(){window.clearTimeout(i),i=window.setTimeout(function(){e.$el.find("#sm2-container div").remove(),soundManager.reboot()},3e3)}}),soundManager.beginDelayedInit()}},audioInit:function(){if(this.hasAudio()){var i=this,e=this.record;this.wasPlaying=void 0,e.time=0,this.player=soundManager.createSound({id:"sound"+(new Date).getTime(),url:this.recordingMP3,autoLoad:!0,whileplaying:function(){i.updateTimeLeft(e.currentTime()),e.seeking||i.$el.find(i.dom.PLAYBAR_PROGRESS).slider("option","value",e.currentTime()/1e3),e.trigger("playUpdate")}.bind(this),onplay:function(){e.play()},onresume:function(){e.play()},onpause:function(){e.pausePlayback()},onload:function(){e.durationEstimate=e.duration=this.duration,e.trigger("loaded")},whileloading:function(){e.duration=null,e.durationEstimate=this.durationEstimate,e.trigger("loading")},onfinish:function(){e.trigger("playPaused"),e.trigger("playStopped"),e.trigger("playEnded")},onsuspend:function(){i.trigger("readyToPlay")}});var t=setInterval(function(){i.player&&i.player.bytesLoaded>0&&(clearInterval(t),i.trigger("readyToPlay"))},16);this.bindRecordHandlers()}},bindRecordHandlers:function(){if(!this.recordHandlersBound){this.recordHandlersBound=!0;var i=this,e=this.record;this.player&&this.record.bind({loading:function(){i.updateDurationDisplay()},loaded:function(){e.commands&&e.commands.push({time:e.endTime()}),i.updateDurationDisplay()},playStarted:function(){i.player.paused?i.player.resume():0===i.player.playState&&i.player.play()},playPaused:function(){i.player.pause()}}),e.bind({playStarted:function(t,r){i.config.switchVersion(e.getVersion()),e.recording||r||(i.editor.reset(e.initData.code,!1),i.drawCanvas.clear(!0),i.drawCanvas.endDraw()),e.recording||i.$el.find("#record").addClass("disabled"),i.$el.find("#restart-code").addClass("disabled"),e.recording||($("html").addClass("playing"),i.$el.find(".disable-overlay").show()),i.editor.unfold(),i.$el.find(i.dom.PLAYBAR_PLAY).find("span").removeClass("glyphicon-play icon-play").addClass("glyphicon-pause icon-pause")},playEnded:function(){i.config.switchVersion(this.initialVersion)},playPaused:function(){$("html").removeClass("playing"),i.$el.find(".disable-overlay").hide(),i.$el.find("#restart-code").removeClass("disabled"),i.$el.find("#record").removeClass("disabled"),i.$el.find(i.dom.PLAYBAR_PLAY).find("span").addClass("glyphicon-play icon-play").removeClass("glyphicon-pause icon-pause")},recordStarted:function(){i.postFrame({recording:!0}),i.$el.find("#draw-widgets").removeClass("hidden").show(),i.$el.find(".disable-overlay").hide(),i.editor.setReadOnly(!1),$("html").removeClass("playing"),e.hasNoChunks()&&(i.drawCanvas.clear(!0),i.drawCanvas.endDraw()),i.$el.find("#save-button, #fork-button").addClass("disabled"),i.$el.find("#record").addClass("toggled")},recordEnded:function(){i.postFrame({recording:!1}),e.recordingAudio&&i.recordView.stopRecordingAudio(),i.$el.find("#save-button, #fork-button").removeClass("disabled"),i.$el.find(i.dom.PLAYBAR_UI).removeClass("ui-state-disabled"),i.$el.find("#record").removeClass("toggled disabled"),e.stopPlayback(),i.$el.find(".disable-overlay").show(),$("html").addClass("playing"),i.editor.setReadOnly(!0),i.$el.find("#draw-widgets").addClass("hidden").hide(),i.drawCanvas.endDraw(),i.drawCanvas.redraw()}}),e.handlers.restart=function(){var e=i.$el.find("#restart-code");e.hasClass("hilite")||(e.addClass("hilite green"),setTimeout(function(){e.removeClass("hilite green")},300)),i.postFrame({restart:!0})},e.currentTime=function(){return i.player?i.player.position:0},e.endTime=function(){return this.duration||this.durationEstimate}}},recordHandler:function(i){if(this.record.recording)return void this.recordView.stopRecordingCommands();var e=this.editor.text();e?this.config.curVersion()!==this.config.latestVersion()?i({error:"outdated"}):this.canRecord()&&!this.hasAudio()?(this.startRecording(),this.editor.focus()):i({error:"exists"}):i({error:"empty"})},startRecording:function(){if(this.bindRecordHandlers(),!this.recordView){var i=this.$el;this.recordView=new ScratchpadRecordView({el:i.find(".scratchpad-dev-record-row"),recordButton:i.find("#record"),saveButton:i.find("#save-button"),record:this.record,editor:this.editor,config:this.config,externalsDir:this.externalsDir,drawCanvas:this.drawCanvas,transloaditTemplate:this.transloaditTemplate,transloaditAuthKey:this.transloaditAuthKey})}this.recordView.initializeRecordingAudio()},saveRecording:function(i){if(!this.record.recorded||!this.record.recordingAudio)return i();var e=new TransloaditXhr({authKey:this.transloaditAuthKey,templateId:this.transloaditTemplate,successCb:function(e){this.recordingMP3=e.mp3[0].url.replace(/^http:/,"https:"),i(null,this.recordingMP3)}.bind(this),errorCb:i});this.recordView.getFinalAudioRecording(function(i){e.uploadFile(i.wav)})},updateDurationDisplay:function(){this.updateTimeLeft(this.record.currentTime()),this.$el.find(this.dom.PLAYBAR_PROGRESS).slider("option","max",this.record.endTime()/1e3)},updateTimeLeft:function(i){this.$el.find(".scratchpad-playbar-timeleft").text("-"+this.formatTime(this.record.endTime()-i))},formatTime:function(i){var e=i/1e3,t=Math.floor(e/60),r=Math.floor(e%60);return(0>t||0>r)&&(t=0,r=0),t+":"+(10>r?"0":"")+r},seekTo:function(i){this.record.seeking||this.$el.find(this.dom.PLAYBAR_PROGRESS).slider("option","value",i/1e3),this.record.seekTo(i)!==!1&&this.player.setPosition(i)},listenMessages:function(i){var e,t=i.originalEvent;try{e=JSON.parse(t.data)}catch(r){}e&&(this.trigger("update",e),e.loaded&&this.$el.find(this.dom.CANVAS_LOADING).hide(),void 0!==e.code&&(this.editor.text(e.code),this.editor.originalCode=e.code,this.restartCode()),null!=e.validate&&(this.validation=e.validate),void 0!==e.lines&&this.editor.toggleGutter(e.lines),e.restart&&this.restartCode(),e.cursor&&(this.editor.setCursor(e.cursor),this.editor.setErrorHighlight(!0)),e.focus&&this.editor.focus())},postFrameOrigin:function(){var i=/^.*:\/\/[^\/]*/.exec(this.$el.find("#output-frame").attr("data-src"));return i?i[0]:window.location.protocol+"//"+window.location.host},postFrame:function(i){this.$el.find("#output-frame")[0].contentWindow.postMessage(JSON.stringify(i),this.postFrameOrigin())},restartCode:function(){this.postFrame({restart:!0})},runCode:function(i){var e={code:i,validate:this.validation||"",version:this.config.curVersion(),settings:this.settings||{},execDir:this.execDir,externalsDir:this.externalsDir,imagesDir:this.imagesDir};this.trigger("runCode",e),this.postFrame(e)},getScreenshot:function(i){$(window).unbind("message.getScreenshot"),$(window).bind("message.getScreenshot",function(e){/^data:/.test(e.originalEvent.data)&&i(e.originalEvent.data)}),this.postFrame({screenshot:!0})},updateCanvasSize:function(i,e){i=i||this.defaultOutputWidth,e=e||this.defaultOutputHeight,this.$el.find(this.dom.OUTPUT_FRAME).width(i),this.$el.find(this.dom.ALL_OUTPUT).height(e),this.$el.find(this.dom.EDITOR).height(this.editorHeight||e),this.trigger("canvasSizeUpdated",{width:i,height:e})},getScreenshot:function(i){$(window).off("message.getScreenshot"),$(window).on("message.getScreenshot",function(e){/^data:/.test(e.originalEvent.data)&&i(e.originalEvent.data)}),this.postFrame({screenshot:!0})},undo:function(){this.editor.undo()},_qualifyURL:function(i){var e=document.createElement("a");return e.href=i,e.href}});