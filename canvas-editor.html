<!DOCTYPE html>
<html>
<head>
	<title>Canvas Video</title>
	<link rel="stylesheet" href="css/style.css"/>
	<script src="js/jquery.js"></script>
	<script src="js/require.js"></script>
	<script src="js/canvas.js"></script>
	<script src="js/jquery.simulate.js"></script>
	<script id="code">
	if ( typeof require !== "undefined" ) {
		require.config({
			paths: {
				ace: "ace/lib/ace",
				pilot: "ace/support/pilot/lib/pilot"
			}
		});
	}
	
	var canvas, ctx, down, x, y, firstX, firstY, prev, draw, line, colors;
	var log = [], playing = true;
	
	var playback = function() {
		var start = log[0], pos = 1, startTime = (new Date).getTime(), evt;
		
		playing = true;
		
		var interval = setInterval(function() {
			var curTime = (new Date).getTime(), evt = log[pos];
		
			if ( evt && (curTime - startTime) > (evt.timeStamp - start.timeStamp) ) {
				if ( evt.type === "keypress" ) {
					var str = String.fromCharCode( evt.charCode ),
						textarea = $("#editor textarea");
					
					if ( str ) {
						var e = document.createEvent("TextEvent");
						e.initTextEvent( "textInput", true, true, null, String.fromCharCode( evt.charCode ) );
						textarea[0].dispatchEvent( e );
					}
				} else if ( evt.type === "keydown" ) {
					if ( evt.keyCode && (evt.keyCode < 48 || evt.keyCode === 32) ) {
						$("#editor textarea").simulate( "keydown", { keyCode: evt.keyCode } );
					}
				
				} else if ( evt.style === "canvas" ) {
					Canvas[ evt.type ].apply( Canvas, evt.args );
				
				} else {
					$("#editor div.ace_content").simulate( evt.type, evt );
				}
			
				pos++;
			
				if ( pos === log.length ) {
					clearInterval( interval );
					playing = false;
					log = [];
					
					$("#record").removeClass("playing")
						.find("span").text( "Record" );
				}
			}
		}, 1 );
	};
	
	var record = function() {
		playing = false;
		logger({ type: "start", timeStamp: (new Date).getTime() });
	};
	
	var logger = function( e ) {
		if ( !playing ) {
			log.push( e );
		}
	};
	
	$(function(){
		function buildEditor() {
			var origCode = $("#code").html();
			$("#editor").html( origCode );
		
			require(["ace/ace", "ace/mode/javascript"], function() {
				var JavaScriptMode = require("ace/mode/javascript").Mode;
				var editor = require("ace/ace").edit( "editor" );

				editor.getSession().setMode(new JavaScriptMode());
				editor.setTheme( "ace/theme/textmate" );
				
				$("#editor textarea").bind( "keydown", logger );
			});
		}
		
		buildEditor();

		canvas = $("#canvas")[0];
		ctx = canvas.getContext("2d");
		down = false;
		prev = [];
		draw = [];
		line = [];

		ctx.shadowBlur = 2;
		ctx.lineCap = "round";
		ctx.lineJoin = "round";
		ctx.lineWidth = 1;

		colors = {
			black: [ 0, 0, 0 ],
			red: [ 255, 0, 0 ],
			orange: [ 255, 165, 0 ],
			green: [ 0, 128, 0 ],
			blue: [ 0, 0, 255 ],
			lightblue: [ 173, 216, 230 ],
			violet: [ 128, 0, 128 ]
		};
		
		$("#canvas-editor").bind({
			mousedown: logger,
			mouseup: logger,
			//mousemove: logger,
			keypress: logger
			//keydown: logger
		});

		$("#toolbar div.color").each(function() {
			$(this).children().css( "background-color", this.id );
		});

		$("#toolbar").delegate( "div.color", "click", function() {
			Canvas.setColor( this.id );
		});

		$("#draw").toggle( Canvas.startDraw, Canvas.endDraw );
		
		$("#record").toggle(function() {
			record();
			
			$(this).addClass("recording")
				.find("span").text( "Recording" );
		}, function() {
			buildEditor();
			Canvas.endDraw();
			
			playback();
			
			$(this).removeClass("recording").addClass("playing")
				.find("span").text( "Playing" );
		});

		$(canvas).bind({
			mousedown: function( e ) {
				// Left mouse button
				if ( e.button === 0 ) {
					firstX = x = e.layerX;
					firstY = y = e.layerY;
					prev = [];
					line = [];
					down = true;

					e.preventDefault();
				}
			},

			mousemove: function( e ) {
				if ( down ) {
					prev.push({ x: e.layerX, y: e.layerY });

					if ( prev.length === 2 ) {
						draw.push( prev );
						line.push( prev ) ;
						prev = [];
					}
				}
			},
			
			mouseup: function() {
				if ( !Canvas.undoRunning ) {
					Canvas.undoStack.push({ name: "drawLine", args: [ firstX, firstY, line ] });
				}
				
				down = false;
			}
		});
		
		$(document).keydown(function(e) {
			// Backspace key
			if ( e.which === 8 ) {
				Canvas.undoStack.pop();
				
				if ( Canvas.undoStack.length === 0 ) {
					Canvas.endDraw();
				
				} else {
					Canvas.clear();
					Canvas.redraw();
				}
				
				e.preventDefault();
			}
		});

		setInterval( Canvas.drawSegments, 16 );
	});
	</script>
</head>
<body>
	<div id="toolbar">
		<div class="button wide" id="draw"><span class="icon">Draw</span></div>
		<div class="button wide" id="record"><span class="icon">Record</span></div>
		<div class="space"></div>
		<div class="color" id="black"><span class="icon"></span></div>
		<div class="color" id="red"><span class="icon"></span></div>
		<div class="color" id="orange"><span class="icon"></span></div>
		<div class="color" id="green"><span class="icon"></span></div>
		<div class="color" id="blue"><span class="icon"></span></div>
		<div class="color" id="lightblue"><span class="icon"></span></div>
		<div class="color" id="violet"><span class="icon"></span></div>
	</div>
	<div id="canvas-editor">
		<div id="editor" style="width: 600px; height: 480px;"></div>
		<canvas id="canvas" width="600" height="480"></canvas>
	</div>
</body>
</html>
